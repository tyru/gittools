#!/bin/sh


code() {
    remote="$1"

    cat <<END_OF_CODE
get_branch() {
    git branch | egrep '^\*' | sed -e 's/^\*\s\+//'
}
my_repository() {
    # If git-subup-{watch-repo,my-repo} are not found,
    # Try to determine if this is my repository (currently by branch name).
    [ ! -e 'git-subup-watch-repo' -a -e 'git-subup-my-repo' -o "`get_branch`" != '(no branch)' ]
}

if my_repository; then
    # Repository which I'm developing
    echo "[SKIP] '\$name' is my repository."
else
    # http://subtech.g.hatena.ne.jp/secondlife/20101104/1288876161
    echo "[FETCH] '\$name' is watching repository."
    git fetch $remote
    git rebase $remote/master
fi

true    # not to stop 'git submodule foreach'.
END_OF_CODE
}


remote='origin'
[ $# != 0 ] && remote="$1"

# --quiet for git-submodule, but verbose for my code :)
git submodule --quiet foreach "`code $remote`"
